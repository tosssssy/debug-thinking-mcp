# アーキテクチャ概要

## ディレクトリ構造

```
src/
├── index.ts              # エントリーポイントとMCPサーバーのセットアップ
├── types/
│   ├── graph.ts         # グラフ構造の型（Node、Edge、DebugGraph）
│   └── graphActions.ts  # アクション型（CREATE、CONNECT、QUERY）
├── services/
│   ├── GraphService.ts  # メイングラフ操作サービス
│   └── GraphStorage.ts  # グラフ永続化レイヤー
├── utils/
│   ├── logger.ts        # ロギングユーティリティ
│   ├── storage.ts       # ファイルシステム操作
│   └── format.ts        # レスポンスフォーマット
└── constants.ts         # アプリケーション定数
```

## 主要コンポーネント

### 1. 型システム (`src/types/`)

- **graph.ts**: コアグラフ型
  - `Node`: すべてのデバッグ要素（問題、仮説など）の基本型
  - `Edge`: ノード間の関係
  - `DebugGraph`: メタデータを含む完全なグラフ構造
  - 特定のノード型: ProblemNode、HypothesisNode、ExperimentNode、ObservationNode、LearningNode、SolutionNode

- **graphActions.ts**: アクション関連の型
  - `CreateAction`: ノード作成のパラメータ
  - `ConnectAction`: エッジ作成のパラメータ
  - `QueryAction`: グラフクエリのパラメータ
  - 各アクションのレスポンス型

### 2. サービス (`src/services/`)

- **GraphService**: デバッグ知識グラフを管理するコアサービス
  - 自動関係推論によるノードとエッジの作成
  - パターン認識と類似性マッチング
  - クエリ実行（類似問題、成功パターンなど）
  - グラフ分析に基づく提案生成

- **GraphStorage**: グラフデータの永続化レイヤー
  - 効率的なストレージとストリーミングのためのJSONL形式
  - ノード、エッジ、メタデータ用の個別ファイル
  - 複数保存を処理するためのロード時重複排除

### 3. ユーティリティ (`src/utils/`)

- **Logger**: 環境ベースの設定による集中ロギング
- **Storage**: JSONL操作のためのファイルシステム抽象化
- **Format**: MCP準拠のレスポンスフォーマット

### 4. 定数 (`src/constants.ts`)
- ファイルパスとディレクトリ名
- サーバーメタデータとバージョン
- エラーメッセージ

## 設計原則

1. **グラフファーストアーキテクチャ**: すべてのデバッグ知識は有向グラフとして表現
2. **知識の蓄積**: すべてのデバッグセッションが成長する知識ベースに貢献
3. **パターン認識**: 成功したデバッグパターンの自動識別
4. **型安全性**: 包括的なTypeScript型によりコンパイル時の安全性を確保
5. **シンプルさ**: 3つのアクション（CREATE、CONNECT、QUERY）だけで完全な機能を提供

## データフロー

1. **リクエスト受信**: MCPサーバーがアクションタイプを含むツールリクエストを受信
2. **アクションディスパッチ**: アクションがGraphServiceメソッドにルーティング
3. **グラフ操作**:
   - CREATE: 自動エッジ作成でノードを追加
   - CONNECT: 明示的に関係を作成
   - QUERY: グラフを検索・分析
4. **永続化**: グラフの変更がJSONLファイルに永続化
5. **レスポンス**: 結果がMCP準拠のレスポンスとしてフォーマット

## 主要機能

### 自動エッジ作成
`parentId`を持つノードを作成する際、システムはノードタイプに基づいて適切なエッジを自動的に作成します：
- 問題 → 問題: `decomposes`
- 問題 → 仮説: `hypothesizes`
- 仮説 → 実験: `tests`
- 実験 → 観察: `produces`
- 観察 → 学習: `learns`

### クエリ機能
- **similar-problems**: パターンに一致する問題を検索
- **successful-patterns**: 解決に至ったデバッグパターンを識別
- **learning-path**: 問題から解決までのパスをトレース
- **graph-visualization**: グラフをMermaid/DOT形式でエクスポート
- **node-details**: ノードの包括的な情報を取得
- **related-nodes**: すべての接続されたノードを検索

### ストレージフォーマット
```
~/.debug-thinking-mcp/
├── nodes.jsonl          # すべてのノード（ロード時に重複排除）
├── edges.jsonl          # すべての関係
└── graph-metadata.json  # グラフレベルの統計
```

## 将来の拡張性

グラフベースのアーキテクチャは簡単な拡張を可能にします：
- 既存のコードを変更せずに新しいノードタイプを追加可能
- 新しいエッジタイプで追加の関係を表現可能
- 新しいクエリタイプで特殊な分析を提供可能
- パターンマッチングアルゴリズムを強化可能
- グラフエクスポートを通じて外部ツールと統合可能